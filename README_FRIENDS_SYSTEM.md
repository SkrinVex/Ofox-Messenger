# Система заявок в друзья для OfoxMessenger

## Описание

Реализована полная система заявок в друзья с поддержкой следующих состояний кнопки:

1. **"Добавить в друзья"** - когда нет связи между пользователями
2. **"Отменить заявку"** - когда текущий пользователь отправил заявку
3. **"Принять"** - когда текущий пользователь получил заявку
4. **"Вы друзья"** - когда пользователи уже друзья

## Установка

### 1. База данных

Выполните SQL скрипт для создания необходимых таблиц:

```sql
-- Выполните содержимое файла backend/database_structure.sql
```

### 2. Backend файлы

Замените следующие PHP файлы на сервере:

- `profile_view.php` → `backend/profile_view.php`
- `friend_request_handler.php` → `backend/friend_request_handler.php`
- `friends_handler.php` → `backend/friends_handler.php`

### 3. Android код

Замените следующие файлы в Android проекте:

- `ApiService.kt` → обновлен с новыми методами API
- `ProfileViewModel.kt` → добавлены методы для работы с заявками
- `ProfileViewActivity.kt` → обновлен UI с новыми состояниями кнопок

## API Endpoints

### 1. Получение профиля с информацией о статусе дружбы

```
GET /ofox/profile_view.php?api_key={key}&user_id={id}
```

**Ответ:**
```json
{
  "success": true,
  "user_id": 123,
  "username": "user123",
  "nickname": "Пользователь",
  "friendship_status": "none|request_sent|request_received|friends|own_profile",
  "is_friend": false,
  ...
}
```

### 2. Отправка заявки в друзья

```
POST /ofox/friend_request_handler.php
```

**Параметры:**
- `api_key` - API ключ пользователя
- `target_id` - ID целевого пользователя
- `action` - "send_request"

### 3. Отмена заявки

```
POST /ofox/friend_request_handler.php
```

**Параметры:**
- `api_key` - API ключ пользователя
- `target_id` - ID целевого пользователя
- `action` - "cancel_request"

### 4. Принятие заявки

```
POST /ofox/friend_request_handler.php
```

**Параметры:**
- `api_key` - API ключ пользователя
- `target_id` - ID отправителя заявки
- `action` - "accept_request"

### 5. Отклонение заявки

```
POST /ofox/friend_request_handler.php
```

**Параметры:**
- `api_key` - API ключ пользователя
- `target_id` - ID отправителя заявки
- `action` - "decline_request"

## Состояния friendship_status

- **"none"** - нет связи между пользователями
- **"request_sent"** - текущий пользователь отправил заявку
- **"request_received"** - текущий пользователь получил заявку
- **"friends"** - пользователи являются друзьями
- **"own_profile"** - собственный профиль пользователя

## Логика работы

### Сценарий 1: Отправка заявки
1. Пользователь A нажимает "Добавить в друзья" на профиле B
2. Создается запись в `friend_requests` со статусом "pending"
3. Создается уведомление для пользователя B
4. У A кнопка меняется на "Отменить заявку"
5. У B при просмотре профиля A появляются кнопки "Принять"/"Отклонить"

### Сценарий 2: Принятие заявки
1. Пользователь B нажимает "Принять"
2. Статус заявки меняется на "accepted"
3. Создаются записи в таблице `friends` (взаимная связь)
4. Создается уведомление для A о принятии
5. У обоих пользователей кнопки меняются на "Вы друзья"/"Написать"

### Сценарий 3: Отмена заявки
1. Пользователь A нажимает "Отменить заявку"
2. Запись удаляется из `friend_requests`
3. Удаляются связанные уведомления
4. Кнопка возвращается к состоянию "Добавить в друзья"

### Сценарий 4: Отклонение заявки
1. Пользователь B нажимает "Отклонить"
2. Статус заявки меняется на "declined"
3. У A кнопка возвращается к "Добавить в друзья"

## Особенности реализации

### Автоматическое принятие встречных заявок
Если пользователь A отправляет заявку пользователю B, а у B уже есть pending заявка от A, то автоматически устанавливается дружба.

### Транзакции
Все операции с базой данных выполняются в транзакциях для обеспечения целостности данных.

### Уведомления
Система автоматически создает уведомления при:
- Отправке заявки в друзья
- Принятии заявки
- Автоматическом принятии встречной заявки

### Безопасность
- Проверка существования пользователей
- Защита от добавления себя в друзья
- Проверка прав доступа для каждого действия
- Валидация всех входных параметров

## Тестирование

Для тестирования системы проверьте следующие сценарии:

1. **Базовый флоу**: A → отправка заявки → B → принятие → дружба
2. **Отмена заявки**: A → отправка → отмена → возврат к исходному состоянию
3. **Отклонение заявки**: A → отправка → B → отклонение → возврат к исходному состоянию
4. **Встречные заявки**: A → заявка B, B → заявка A → автоматическая дружба
5. **Повторные заявки**: проверка защиты от дублирования
6. **Граничные случаи**: несуществующие пользователи, неверные параметры

## Поддержка

При возникновении проблем проверьте:

1. **Логи сервера** - все ошибки записываются в error_log
2. **Структуру БД** - убедитесь, что все таблицы созданы
3. **Права доступа** - проверьте права на выполнение SQL запросов
4. **API ключи** - убедитесь в корректности передаваемых ключей

## Версия

Версия системы: 1.0
Дата создания: 28.07.2025
Совместимость: Android API 21+, PHP 7.4+, MySQL 5.7+